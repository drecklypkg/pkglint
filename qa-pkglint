#! /bin/sh
set -eu

srcdir="$HOME/pkglint"
archivedir="$srcdir/archive"
pkgsrcdir="$HOME/git/pkgsrc"

genrunid() {
  if [ -n "${genrunid-}" ]; then
    return
  fi
  headcommit=$(cd "$srcdir" && git rev-parse --short HEAD)
  if (cd "$srcdir" && git diff --quiet && git diff --cached --quiet); then
    timestamp="$(cd "$srcdir" && git show -s --format=%ai HEAD | awk -F '[- :]' '{print $1$2$3"-"$4$5}')"
    runid="$timestamp-$headcommit"
  else
    runid="$(date +'%Y%m%d-%H%M')-$headcommit-mod-$$"
  fi
}

install() {
  genrunid
  echo "=> Installing pkglint"
  (cd "$srcdir" && chmod 644 *.go)
  (cd "$srcdir" && go fmt && go build && go test && go install && cp "$GOPATH/bin/pkglint.exe" "$archivedir/$runid.exe")
}

install_notest() {
  genrunid
  echo "=> Installing pkglint"
  (cd "$srcdir" && chmod 644 *.go)
  (cd "$srcdir" && go fmt && go build && go install && cp "$GOPATH/bin/pkglint.exe" "$archivedir/$runid.exe")
}

analyze() {
  echo "=> Analyzing test coverage"
  (cd ~/pkglint && gocover)

  echo "=> Analyzing code style"
  (cd ~/pkglint && gometalinter --exclude "exported method|unexported|drop this else") | less
}

netbsd() {
  echo "=> Copying files to NetBSD VM"
  rsync -a --delete --rsync-path=/home/rillig/pkg/bin/rsync \
    --exclude="*yacc.go" --include="*.go" --exclude="*" \
    ~/pkglint/ netbsd:proj/pkgsrc/pkgtools/pkglint/files/

  echo "=> Installing NetBSD package"
  ssh netbsd ". .bash_profile && cd proj/pkgsrc/pkgtools/pkglint && bmake update"
}

pkgsrc() {
  genrunid
  echo "=> Running pkglint on the pkgsrc tree"
  time (cd "$pkgsrcdir" && "$archivedir/$runid.exe" -pr -Wall -Call) > "$archivedir/$runid.tmp" || true
  mv "$archivedir/$runid.tmp" "$archivedir/$runid.out"
}

diffs() {
  echo "=> Generating diffs"
  (
    cd "$archivedir"
    for out in *.out; do
      diff -u "reference" "$out" > "${out%.out}.diff" || true
    done
  )
}

if [ $# -eq 0 ]; then
  set -- genrunid install pkgsrc diffs
fi
for cmd in "$@"; do
  "$cmd"
done
echo "=> OK"
